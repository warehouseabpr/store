<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="icon" type="image/png" href="https://www.img.in.th/images/4a47c844c6291da4c9c196e0a0865c2e.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            background-color: #F7F7F7;
            font-family: 'Sarabun', sans-serif;

        }

        img[alt="logo"] {
            vertical-align: baseline;
        }
    </style>
    <title>Request & Return</title>
</head>

<body>
    <section class="mt-3 ms-3">
        <p class="display-3 fw-bold text-primary"><img
                src="https://www.img.in.th/images/4a47c844c6291da4c9c196e0a0865c2e.png" border="0" alt="logo"
                width="60px" />&nbsp;Request & Return</p>
    </section>

    <section>
        <div class="container-fluid">
            <div class="row justify-content-start">
                <div class="col-md-4 mt-3">
                    <label for="id" class="form-label">เลขประจำตัวผู้เบิก /ID No</label>
                    <input type="text" id="id" class="form-control" readonly>
                </div>
                <div class="col-md-4 mt-3">
                    <label for="name" class="form-label">ชื่อ / Name</label>
                    <input type="text" id="name" class="form-control" readonly>
                </div>
                <div class="col-md-4 mt-3">
                    <label for="section" class="form-label">แผนก / Section</label>
                    <input type="text" id="section" class="form-control" readonly>
                </div>
                <div class="col-md-4 mt-3">
                    <label for="department" class="form-label">ฝ่าย / department</label>
                    <input type="text" id="department" class="form-control" readonly>
                </div>
                <div class="col-md-4 mt-3">
                    <label for="workorder" class="form-label">เลขใบงาน/Work Order No</label>
                    <input type="text" id="workorder" class="form-control">
                </div>
                <div class="col-md-4 mt-3">
                    <label for="kks" class="form-label">เลขอุปกรณ์ / KKS No.</label>
                    <input type="text" id="kks" class="form-control">
                </div>
                <div class="col-md-4" hidden>
                    <input type="text" id="site" class="form-control" readonly>
                </div>
            </div>
            <div class="row justify-content-center mt-3">
                <div class="col-auto">
                    <button class="btn btn-lg btn-primary" id="qr-btn" data-isscan="false"><i
                            class="fas fa-qrcode"></i>&nbsp;SCAN</button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-lg btn-warning" id="save-btn" style="display: none;"><i
                            class="far fa-save"></i>&nbsp;บันทึก</button>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row justify-content-start m-2" id="itemlist">
            </div>
        </div>

        <!-- <iframe src="https://docs.google.com/gview?url=https://drive.google.com/uc?id=1cDL63SFbdXx2a-4MhKp25xZ1EpJNskYJ&embedded=true" frameborder="0"></iframe> -->
    </section>
    <section>
        <div class="container-fluid" id="preview" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <img alt="previewpdf" class="img-fluid">
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-auto">
                    <button class="btn btn-warning" id="download">Download PDF</button>
                </div>
            </div>
        </div>
    </section>
    <section class="text-center fixed-bottom ">
        <!-- <div class="container-fluid"> -->
        <!-- <div class="row justify-content-center"> -->
        <center>
            <div class="col-md-10 " id="reader">
            </div>
        </center>
        <div class="container-fluid  fixed-bottom mb-3" style="display: none;">
            <div class="row justify-content-center">
                <div class="col text-center">
                    <button class="btn btn-danger btn-lg position-relative" id="close-btn"
                        onclick="$('#qr-btn').click()">Stop
                        <span
                            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark"
                            style="display: none;">
                            99+
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </section>
    <script>
        var scripturl = 'https://script.google.com/macros/s/AKfycbzcxHj9Y914WISB5KAGrc9SQ-noerFCqrvKv3TNo0WT-HHShbjkprE7iRjL51-g_XZX/exec'
        var vw, vh
    </script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        // var vConsole = new window.VConsole();
    </script>
    <script>
        function requestLogin() {
            Swal.fire({
                icon: 'info',
                title: 'ลงชื่อเข้าใช้',
                input: 'text',
                inputLabel: 'กรุณากรอกรหัสพนักงาน',
                inputPlaceholder: 'Pxxxxx',
                inputAutoTrim: true,
                inputValidator: (value) => {
                    if (!value.match(/[A-Za-z]\d{5}/)) {
                        return 'รหัสพนักงานไม่ถูกต้อง'
                    }
                },
                confirmButtonText: 'ลงชื่อเข้าใช้'
            }).then(result => {
                // Swal.fire({
                //     title: 'กำลังโหลด...',
                //     allowOutsideClick: false
                // })
                // Swal.showLoading(Swal.getConfirmButton())
                getuser(result.value)
            })
        }
        function getuser(id) {
            let ref = database.ref("employee")
            return ref.child(id.toUpperCase()).once("value").then(snap => {
                let result = snap.val();
                if (!result) {
                    return Swal.fire({
                        icon: 'error',
                        title: 'ไม่พบรหัสพนักงานนี้',
                        text: 'กรุณาตรวจสอบรหัสอีกครั้ง หรือติดต่อผู้ดูแลระบบ'
                    }).then(() => {
                        requestLogin()
                    })
                }
                $('#id').val(result['รหัสใหม่'])
                $('#name').val(result['ชื่อภาษาอังกฤษ'])
                $('#section').val(result['แผนก'])
                $('#department').val(result['ฝ่าย'])
                $('#site').val(result['site'])
                Swal.fire({
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1000
                })
            });
        }
        var isScan = true
        var html5QrCode
        function scanQrCode() {
            let length = Object.keys(formdata.items).length
            if (length > 0) $('.badge').html(`${length} รายการ`).show()
            else $('.badge').html('').hide()
            html5QrCode = new Html5Qrcode("reader");
            const aspectRatio = vh > vw ? vh / vw : vw / vh
            const config = { fps: 30, qrbox: 300, aspectRatio: aspectRatio };
            $('#reader').show()
            $('#close-btn').closest('.fixed-bottom').show()
            const qrCodeSuccessCallback = async function (decodedText, decodedResult) {
                console.log(decodedText)
                if (isScan) {
                    isScan = false
                    $('#reader').hide()
                    $('#code').html(decodedText)
                    let data = await getFirebaseData(decodedText)
                    if (data == null) {
                        return Swal.fire({
                            icon: 'error',
                            title: 'ผิดพลาด',
                            html: decodedText + '<br>ไม่พบข้อมูลรายการนี้ใน stock'
                        })
                    }
                    Swal.fire({
                        title: 'เพิ่มข้อมูล',
                        html: `<div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-12 text-center">
                    <p class="text-success fs-5 fw-bold" id="code">${data.summary}</p>
                </div>
                <div class="col-12 text-center">
                    <p>กรุณาระบุ<span class="text-primary fw-bold"> Quantity</span> และ <span class="text-primary fw-bold">Type of Request</span></p>
                </div>
                <div class="col-12 text-center" onchange="$('#number').closest('div').slideDown(100)">
                    <label for="quantity" class="form-label">Quantity</label>
                    <select type="text" id="quantity" class="form-select">
                        <option value="" selected disabled></option>
                        <option value="Issue">Issue</option>
                        <option value="Return">Return</option>
                        <option value="Use">Use</option>
                    </select>
                </div>
                <div class="col-12 text-center" style="display: none">
                    <label for="number" class="form-label">จำนวน</label>
                    <input type="text" id="number" class="form-control">
                </div>
                <div class="col-12 text-center">
                    <label for="typeRequest" class="form-label">Type of Request</label>
                    <select type="text" id="typeRequest" class="form-select">
                        <option value="" selected disabled></option>
                        <option value="Tools">Tools</option>
                        <option value="PPE">PPE</option>
                        <option value="Spare Parts">Spare Parts</option>
                        <option value="Consumable">Consumable</option>
                    </select>
                </div>
            </div>
        </div>`,
                        showDenyButton: true,
                        showCancelButton: true,
                        denyButtonText: 'แสกนใหม่',
                        cancelButtonText: 'ปิด',
                        confirmButtonText: 'บันทึก',
                        allowOutsideClick: false,
                        reverseButtons: true,
                        preConfirm: () => {
                            if (($('#quantity').val() != '' && $('#quantity').val() != null) && $('#number').val() == '') {
                                $('#number').focus()
                                return false
                            }
                            return [
                                decodedText,
                                $('#quantity').val(),
                                $('#typeRequest').val(),
                                $('#number').val(),
                                data
                            ]
                        }
                    }).then(async result => {
                        isScan = true
                        if (result.isConfirmed) {
                            await appendList(result.value)

                            // $('#reader').show(1, function () {
                            //     let height = $(document).height()
                            //     $('html,body').animate({ scrollTop: height }, 1)
                            // })

                            // html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
                        } else if (result.isDenied) {
                            $('#reader').show(1, function () {
                                let height = $(document).height()
                                $('html,body').animate({ scrollTop: height }, 1)
                            })
                            // html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
                        } else {
                            stopScan()
                        }
                    })
                }
            }
            isScan = true
            $('html,body').animate({ scrollTop: $(document).height() }, 1)
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);

        }
        function stopScan() {
            html5QrCode.stop().then((ignore) => {
                $('#qr-btn').attr('data-isscan', 'false')
                $('#qr-btn').html('<i class="fas fa-qrcode"></i>&nbsp;SCAN').removeClass('btn-secondary').addClass('btn-primary')
                $('#itemlist').show()
                $('#reader').hide()
                $('#close-btn').closest('.fixed-bottom').hide()
            }).catch((err) => {
                console.log(err)
                // Stop failed, handle it.
            });
        }
        let formdata = { items: {} }
        function appendList(value) {
            let data = value[4]
            let key = value[0].replace(/\./g, '_').split('|')[0]
            formdata.items[key] = data
            formdata.items[key].quantity = value[1]
            formdata.items[key].quantitycount = value[3]
            formdata.items[key].requesttype = value[2]
            $('#itemlist').html('')
            Object.keys(formdata.items).forEach((item, count) => {
                let div = document.createElement('div')
                let i = document.createElement('i')
                let text1 = formdata.items[item].quantity == null ? '&nbsp;&nbsp;&nbsp;&nbsp;' : `${formdata.items[item].quantity}&nbsp;${formdata.items[item].quantitycount}&nbsp;unit`
                let text2 = formdata.items[item].requesttype == null ? '&nbsp;&nbsp;&nbsp;&nbsp;' : formdata.items[item].requesttype
                $(i).addClass('far fa-times-circle fs-5 fw-bold text-danger btn')
                $(div).addClass('col-md-12 rounded shadow-sm border border-info mt-2 p-2').append((count + 1) + '&nbsp;&nbsp;').append(i).append(`&nbsp;&nbsp;${formdata.items[item].summary}&nbsp;&nbsp;<span><i class="fas fa-forward text-warning"></i></span>&nbsp;&nbsp;${text1}&nbsp;&nbsp;<span><i class="fas fa-forward text-warning"></i></span>&nbsp;&nbsp; ${text2}`)
                $('#itemlist').append(div).hide()
                $('.badge').html(`${Object.keys(formdata.items).length} รายการ`).show()
                $(i).click(function () {
                    $(div).remove()
                    delete formdata.items[item]
                    let length = Object.keys(formdata.items).length
                    if (length <= 0) $('#save-btn').slideUp(200)

                })
            })
            $('#save-btn').slideDown(200)

            if (Object.keys(formdata.items).length >= 10) {
                stopScan()
                $('#qr-btn').attr('data-isscan', 'false')
                $('#qr-btn').html('<i class="fas fa-qrcode"></i>&nbsp;SCAN').removeClass('btn-secondary').addClass('btn-primary')
            }

            $('#reader').show(1, function () {
                let height = $(document).height()
                $('html,body').animate({ scrollTop: height }, 1)
            })

        }
        $('#qr-btn').click(function () {
            if (Object.keys(formdata.items).length >= 10) {
                return Swal.fire({
                    icon: 'info',
                    text: 'คุณสามารถทำรายการได้ครั้งละไม่เปิด 10 รายการ'
                })
            }
            if ($(this).attr('data-isscan') == 'false') {
                scanQrCode()
                $(this).attr('data-isscan', 'true')
                $(this).html('<i class="fas fa-qrcode"></i>&nbsp;STOP').removeClass('btn-primary').addClass('btn-secondary')
            } else {
                stopScan()
                $(this).attr('data-isscan', 'false')
                $(this).html('<i class="fas fa-qrcode"></i>&nbsp;SCAN').removeClass('btn-secondary').addClass('btn-primary')
            }
        })
        $('#save-btn').click(function () {
            event.preventDefault()
            let data = {
                id: $('#id').val(),
                name: $('#name').val(),
                section: $('#section').val(),
                department: $('#department').val(),
                workorder: $('#workorder').val(),
                kks: $('#kks').val(),
                formdata: JSON.stringify(formdata)
            }

            Swal.fire({
                icon: 'info',
                title: 'กำลังบันทึก...',
                allowOutsideClick: false
            })
            Swal.showLoading(Swal.getConfirmButton())
            $.post(scripturl + '?opt=savedata', data, result => {
                Swal.fire({
                    icon: 'info',
                    title: 'กำลังสร้าง PDF...',
                    allowOutsideClick: false
                })
                Swal.showLoading(Swal.getConfirmButton())
                $.post(scripturl + '?opt=createpdf', { key: result, site: $('#site').val() }, pdf => {
                    Swal.fire({
                        icon: 'success',
                        title: 'SUCCESS',
                        showConfirmButton: false,
                        timer: 1000
                    }).then(() => {
                        Swal.fire({
                            title: 'PDF',
                            text: 'กดปุ่มเพื่อดาวน์โหลดแบบฟอร์ม',
                            imageUrl: pdf.thumbnail,
                            // imageWidth: 400,
                            // imageHeight: 200,
                            imageAlt: 'Custom image',
                            showCancelButton: true,
                            confirmButtonText: 'Download',
                            cancelButtonText: 'Close'
                        }).then(res => {
                            $('img[alt="previewpdf"]').attr('src', pdf.thumbnail)
                            $('#download').click(() => {
                                window.open(pdf.url, '_blank')
                            })
                            $('#preview').slideDown(500)
                            if (res.isConfirmed) {
                                window.open(pdf.url, '_blank')
                            }
                        })
                    })
                })
            })
        })
        $(document).ready(() => {
            requestLogin()
            vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)
            vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)
            $('#reader').attr('style', `width: ${vw}px; height: ${vh}px`).hide()
            // $('iframe').attr('width', vw).attr('height', vw/1.4142)
        });
    </script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC6VWvm0NgrgfdnoBluqucD1J7havudTxg",
            authDomain: "store-return-request.firebaseapp.com",
            databaseURL: "https://store-return-request-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "store-return-request",
            storageBucket: "store-return-request.appspot.com",
            messagingSenderId: "524687083469",
            appId: "1:524687083469:web:7c6ee1679cd4c6bda76684",
        };
        !firebase.apps.length ? firebase.initializeApp(firebaseConfig) : firebase.app();
        var database = firebase.database();
        function getFirebaseData(key) {
            key = key.replace(/\./g, '_').replace(/-/g, '_').split('|')
            key = key[0] + ',' + key[1]

            let ref = database.ref("stock")
            return ref.child(key).once("value").then(snap => {
                let data = snap.val();

                return data
            });
        }
    </script>
</body>

</html>
